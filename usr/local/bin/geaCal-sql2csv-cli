#!/usr/bin/env python3
import socket
import json
import sys

HOST = "127.0.0.1"
PORT = 7777

def query(sql):
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((HOST, PORT))
    s.sendall(sql.encode())
    data = s.recv(10_000_000)
    s.close()
    return json.loads(data.decode())

# LibreOffice ruft dieses Skript mit SQL param auf
if __name__ == "__main__":
    sql = " ".join(sys.argv[1:])
    rows = query(sql)

    if not rows:
        sys.exit(0)

    # CSV-Ausgabe (LibreOffice erwartet Tabellen-formatiert)
    columns = rows[0].keys()
    print(",".join(columns))

    for row in rows:
        print(",".join(str(row[col]) for col in columns))

