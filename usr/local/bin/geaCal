# -----------------------------------------------------------------------------
# Project:        GaussEasterAlgorithm
# File:           geaCal
# Author:         Christian Klose
# Email:          ghostcoder@gmx.de
# GitHub:         https://github.com/GhostCoder74/Set-Project-Headers (GhostCoder74)
# Copyright (c) 2025 Christian Klose
# SPDX-License-Identifier: GPL-3.0-or-later
#
# This file is part of GaussEasterAlgorithm.
# Do not remove this header.
# Header added by https://github.com/GhostCoder74/Set-Project-Headers
# -----------------------------------------------------------------------------


import sys
import os
import json
import argparse

# ----------------------------------------------------------------------
# Add module path: /opt/geaCal/modules
# ----------------------------------------------------------------------
MODULE_DIR = "/opt/geaCal/modules"
if MODULE_DIR not in sys.path:
    sys.path.insert(0, MODULE_DIR)

try:
    from translator import set_runtime_language
    from holidays import get_holiday, list_holidays_for_year
    from calendar_data import build_calendar
    from create_language import create_language_file
except Exception as e:
    print("ERROR: Could not load modules from /opt/geaCal/modules")
    print(f"Details: {e}")
    sys.exit(1)

# ----------------------------------------------------------------------
def parse_args():
    parser = argparse.ArgumentParser(
        description="geaCal â€“ Calendar / Holiday Tool",
        formatter_class=argparse.RawTextHelpFormatter
    )

    parser.add_argument("-y", "--year", type=int, help="select year")
    parser.add_argument("-l", "--list", action="store_true", help="list holidays for a year")
    parser.add_argument("-e", "--easter", action="store_true", help="print Easter Sunday date")
    parser.add_argument("-j", "--json", action="store_true", help="JSON output")
    parser.add_argument("--lang", help="Override language (de, en, ...)")
    parser.add_argument("--create-lang", help="Create new language file from English base")

    # command-mode compatibility
    parser.add_argument("command", nargs="?", help="legacy commands: holiday, range, help")
    parser.add_argument("value1", nargs="?", help="date or start year")
    parser.add_argument("value2", nargs="?", help="end year")

    return parser.parse_args()

# ----------------------------------------------------------------------
def output(data, use_json=False):
    if use_json:
        print(json.dumps(data, indent=2))
    else:
        if isinstance(data, list):
            for line in data:
                print(line)
        else:
            print(data)

# ----------------------------------------------------------------------
def main():
    args = parse_args()

    # ==================================================================
    # MODE A: LANGUAGE SWITCH OR CREATE LANGUAGE FILE
    # ==================================================================
    if args.lang:
        set_runtime_language(args.lang)
        print(f"Language set to: {args.lang}")

    if args.create_lang:
        try:
            path = create_language_file(args.create_lang)
            print(f"Created language file: {path}")
        except Exception as e:
            print(f"ERROR: {e}")
            sys.exit(1)
        return

    # ==================================================================
    # MODE B: SHORT OPTION MODE
    # ==================================================================
    if args.easter:
        # Easter for specific year or current year
        from easter import easter_sunday

        year = args.year if args.year else int(os.popen("date +%Y").read())
        easter_date = easter_sunday(year)

        output({"easter": str(easter_date)} if args.json else str(easter_date),
               use_json=args.json)
        return

    if args.year and args.list:
        # List holidays for a given year
        holidays = list_holidays_for_year(args.year)
        output(holidays if not args.json else {"holidays": holidays},
               use_json=args.json)
        return

    if args.year and not args.list and not args.easter:
        print("You used --year but did not specify any action (e.g. --list)")
        return

    # ==================================================================
    # MODE C: LEGACY COMMAND MODE (holiday, range)
    # ==================================================================
    if args.command == "help":
        os.system("geaCal --help")
        return

    if args.command == "holiday":
        if not args.value1:
            print("Missing date. Example: geaCal holiday 2025-04-18")
            return
        try:
            y, m, d = map(int, args.value1.split("-"))
        except:
            print("Invalid date format. Expected YYYY-MM-DD")
            return
        result = get_holiday(y, m, d)
        output(result if result else "No holiday", args.json)
        return

    if args.command == "range":
        if not args.value1 or not args.value2:
            print("Usage: geaCal range STARTYEAR ENDYEAR")
            return
        try:
            start = int(args.value1)
            end = int(args.value2)
        except:
            print("Years must be integers")
            return

        cal = build_calendar(start, end)
        output(cal, args.json)
        return

    # Nothing matched
    if not any([args.easter, args.list, args.year, args.command, args.create_lang]):
        print("No action given. Use --help.")
        return

# ----------------------------------------------------------------------
if __name__ == "__main__":
    main()

